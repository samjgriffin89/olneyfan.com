<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Sam J Griffin | Programmatically Updating a Sublayout's Datasource</title>
    <meta name="description" content="I am Sam Griffin, a full stack developer currently working at Cardfree,building out RESTful services that supports our mobile apps and customer portal.  For the most part I am working in .NET using Web API, but am becoming more immersed in RoR and grails.
" >
    <meta name="google-site-verification" content="cT3CHL7PrHfUex3GIuLkyjnk-deuZyedUYGqJGOKGEc" />

    <link rel="stylesheet" href="/css/main.css">
    <link rel="alternate" type="application/rss+xml" title="Your awesome title" href="/feed.xml">
  </head>
  <body>
    <div id="wrapper" class="wrapper">
      
      <header class="header">
  <hgroup>
  <h1>
  <a href="/">Sam J Griffin</a>
  </h1>
  <h2>
  <a href="/">Full Stack Developer</a>
  </h2>
  </hgroup>
  <nav id="primaryNav" class="navigation">
    <ul>
      <li>
        <a href="/travel">Travel</a>
      </li>
      <li>
        <a href="/dev-posts">Tech & Coding</a>
      </li>
      <li>
        <a href="https://github.com/samjgriffin89">Projects</a>
      </li>
      <li>
        <a href="https://gist.github.com/samjgriffin89">Code Snippets</a>
      </li>
    </ul>
  </nav>
</header>

      <section class="main-content">
      	<section class="post-wrapper">
	<article class="post">
		<hgroup>
			<div class="post-title">
				<h3>Programmatically Updating a Sublayout's Datasource</h3>
				
			</div>
			<h5>September 23, 2013</h5>
		</hgroup>
		<p>
		<p>Of course if you are updating a single instance of sublayout’s data source or you can just make the change on a template level, the best approach would be to make the update in Sitecore manually. However, I came across a situation where I needed to update a few sublayouts’ data sources throughout a new site in a multi-site solution, where I could not update the template standard values without effecting older sites and manually updating it could have taking days.</p>

<p>To remedy this situation, I put together a small script that takes in the sublayout’s name you want to update, the new data source, and the item you will be updating. I also put in an option in the initial submit of the data to include all the items descendants so I did not have to go through each item myself, but could run the script from the home node.</p>

<p>To trigger my script, a submit button click is required once all the proper information has been entered.</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">void</span> <span class="nf">btnSubmit_Click</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">EventArgs</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>

    <span class="kt">string</span> <span class="n">itm_guid</span> <span class="p">=</span> <span class="n">txtItemToChange</span><span class="p">.</span><span class="n">Text</span><span class="p">.</span><span class="nf">Trim</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(!</span><span class="kt">string</span><span class="p">.</span><span class="nf">IsNullOrEmpty</span><span class="p">(</span><span class="n">itm_guid</span><span class="p">))</span> <span class="p">{</span>
        
        <span class="c1">// Get the item we are updating
</span>        <span class="n">Item</span> <span class="n">itm</span> <span class="p">=</span> <span class="n">Sitecore</span><span class="p">.</span><span class="n">Context</span><span class="p">.</span><span class="n">Database</span><span class="p">.</span><span class="nf">GetItem</span><span class="p">(</span><span class="n">itm_guid</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">chkIncludeDescendants</span><span class="p">.</span><span class="n">Checked</span><span class="p">)</span> <span class="p">{</span>

            <span class="c1">// Get all the descendants
</span>            <span class="n">Item</span><span class="p">[]</span> <span class="n">descendants</span> <span class="p">=</span> <span class="n">itm</span><span class="p">.</span><span class="n">Axes</span><span class="p">.</span><span class="nf">GetDescendants</span><span class="p">();</span>

            <span class="c1">// Add the current item
</span>            <span class="n">descendants</span><span class="p">.</span><span class="nf">ToList</span><span class="p">().</span><span class="nf">Insert</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">itm</span><span class="p">);</span>
         
            <span class="k">foreach</span> <span class="p">(</span><span class="n">Item</span> <span class="n">d</span> <span class="k">in</span> <span class="n">descendants</span><span class="p">)</span> <span class="p">{</span>
                <span class="nf">UpdateItemDatasource</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="nf">UpdateItemDatasource</span><span class="p">(</span><span class="n">itm</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>Once the item is retrieved, either just update it or get all of its descendants and then loop over all of them and updating them as well. Here is what the actual update function looks like:</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">private</span> <span class="k">void</span> <span class="nf">UpdateItemDatasource</span><span class="p">(</span><span class="n">Item</span> <span class="n">itm</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">itm</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>                    
        <span class="c1">// Get the sublayout to update
</span>        <span class="kt">string</span> <span class="n">sublayout_name</span> <span class="p">=</span> <span class="n">txtSublayout</span><span class="p">.</span><span class="n">Text</span><span class="p">.</span><span class="nf">Trim</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(!</span><span class="kt">string</span><span class="p">.</span><span class="nf">IsNullOrEmpty</span><span class="p">(</span><span class="n">sublayout_name</span><span class="p">))</span> <span class="p">{</span>
            <span class="c1">// Get the renderings on the item
</span>            <span class="n">RenderingReference</span><span class="p">[]</span> <span class="n">refs</span> <span class="p">=</span> <span class="n">itm</span><span class="p">.</span><span class="n">Visualization</span><span class="p">.</span><span class="nf">GetRenderings</span><span class="p">(</span><span class="n">Sitecore</span><span class="p">.</span><span class="n">Context</span><span class="p">.</span><span class="n">Device</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">refs</span><span class="p">.</span><span class="nf">Any</span><span class="p">())</span> <span class="p">{</span>
                <span class="c1">// Get the specified rendering
</span>                <span class="n">RenderingReference</span> <span class="n">rendering</span> <span class="p">=</span> <span class="n">refs</span><span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">r</span> <span class="p">=&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">RenderingItem</span><span class="p">.</span><span class="n">Name</span> <span class="p">==</span> <span class="n">sublayout_name</span><span class="p">)</span>
                                                   <span class="p">.</span><span class="nf">ToList</span><span class="p">()</span>
                                                   <span class="p">.</span><span class="nf">FirstOrDefault</span><span class="p">();</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">rendering</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>

                    <span class="kt">string</span> <span class="n">new_datasource</span> <span class="p">=</span> <span class="n">txtDatasource</span><span class="p">.</span><span class="n">Text</span><span class="p">.</span><span class="nf">Trim</span><span class="p">();</span>
                    <span class="k">if</span> <span class="p">(!</span><span class="kt">string</span><span class="p">.</span><span class="nf">IsNullOrEmpty</span><span class="p">(</span><span class="n">new_datasource</span><span class="p">))</span> <span class="p">{</span>

                        <span class="c1">// Get the layout definitions and the device
</span>                        <span class="n">LayoutField</span> <span class="n">layoutField</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">LayoutField</span><span class="p">(</span><span class="n">itm</span><span class="p">.</span><span class="n">Fields</span><span class="p">[</span><span class="n">Sitecore</span><span class="p">.</span><span class="n">FieldIDs</span><span class="p">.</span><span class="n">LayoutField</span><span class="p">]);</span>
                        <span class="n">LayoutDefinition</span> <span class="n">layoutDef</span> <span class="p">=</span> <span class="n">LayoutDefinition</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="n">layoutField</span><span class="p">.</span><span class="n">Value</span><span class="p">);</span>
                        <span class="n">DeviceDefinition</span> <span class="n">deviceDef</span> <span class="p">=</span> <span class="n">layoutDef</span><span class="p">.</span><span class="nf">GetDevice</span><span class="p">(</span><span class="n">Sitecore</span><span class="p">.</span><span class="n">Context</span><span class="p">.</span><span class="n">Device</span><span class="p">.</span><span class="n">ID</span><span class="p">.</span><span class="nf">ToString</span><span class="p">());</span>

                        <span class="c1">// Update the renderings datasource
</span>                        <span class="n">deviceDef</span><span class="p">.</span><span class="nf">GetRendering</span><span class="p">(</span><span class="n">rendering</span><span class="p">.</span><span class="n">RenderingID</span><span class="p">.</span><span class="nf">ToString</span><span class="p">()).</span><span class="n">Datasource</span> <span class="p">=</span> <span class="n">new_datasource</span><span class="p">;</span>

                        <span class="c1">// Save the layout changes
</span>                        <span class="n">itm</span><span class="p">.</span><span class="n">Editing</span><span class="p">.</span><span class="nf">BeginEdit</span><span class="p">();</span>
                        <span class="n">layoutField</span><span class="p">.</span><span class="n">Value</span> <span class="p">=</span> <span class="n">layoutDef</span><span class="p">.</span><span class="nf">ToXml</span><span class="p">();</span>
                        <span class="n">itm</span><span class="p">.</span><span class="n">Editing</span><span class="p">.</span><span class="nf">EndEdit</span><span class="p">();</span>

                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>This goes through the current item’s renderings and using LINQ to select the current sublayout we are targeting. Then we get the get the item’s layout definition and device definition in order to get the specified rendering mapped on the layout definition and update its data source.</p>

<p>We have to do it this way because the RenderingReference will only provide properties to get the values of the properties, but not to set them. Additionally, it is important to reset the layout field’s value once the update is complete, otherwise the changes will be lost.</p>

		</p>	
		<p>
			<strong>Tags:</strong>
			Sitecore,.NET,C#
		</p>
		<a href="/posts">Back to Posts</a>
	</article>
	<div class="sidebar">
	<!-- <h4>Search</h4>
	<div class="posts-search">
		<input type="text" placeholder="Search Posts" />
		<button class="btn primary-btn">Submit</button>
		
		<a class="clear-results" href="/posts">Clear Results</a>
	</div> -->
	<h4>About the Author</h4>
	<div class="about--side">
		<p>I am a senior .NET engineer currently working at <a href="http://www.cardfree.com">CARDFREE</a> building out RESTful services to supports our mobile and web apps. My focus currently is around scalability, security, and ensuring our solutions are maintainable.</p>

<p>Originally from Boston, but have been living in Denver for several years now. In my spare time I try to keep pace with my energentic golden, hike and ski, and occassionally post something interesting.</p>
	</div>
</div>
</section>
      </section>
    </div>

    
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-24433484-1', 'auto');
  ga('send', 'pageview');
</script>

  </body>
</html>